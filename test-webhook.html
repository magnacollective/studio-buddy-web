<!DOCTYPE html>
<html>
<head>
    <title>Stripe Webhook Test</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; }
        button { padding: 10px 20px; margin: 10px; background: #0066cc; color: white; border: none; cursor: pointer; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-left: 4px solid #0066cc; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
        .success { color: #006600; }
        .error { color: #cc0000; }
    </style>
</head>
<body>
    <h1>üß™ Stripe Integration Test</h1>
    
    <div class="test-section">
        <h3>1. Test Webhook Endpoint</h3>
        <p>Test if your webhook endpoint is reachable:</p>
        <button onclick="testWebhookEndpoint()">Test Webhook URL</button>
        <div id="webhook-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Checkout Session Creation</h3>
        <p>Test creating a Stripe checkout session:</p>
        <button onclick="testCheckoutSession()">Test Checkout Creation</button>
        <div id="checkout-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. Environment Variables Check</h3>
        <p>Verify your environment variables are configured:</p>
        <button onclick="checkEnvironment()">Check Environment</button>
        <div id="env-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. Stripe Test Payment</h3>
        <p>Use test card: <strong>4242 4242 4242 4242</strong></p>
        <p>Any future date, any CVC, any ZIP</p>
        <button onclick="openTestPayment()">Open Test Payment</button>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function testWebhookEndpoint() {
            const result = document.getElementById('webhook-result');
            result.innerHTML = 'Testing webhook endpoint...';

            try {
                // Test if webhook endpoint exists
                const response = await fetch(`${API_BASE}/api/stripe-webhook`, {
                    method: 'GET'
                });

                if (response.status === 405) {
                    result.innerHTML = '<span class="success">‚úÖ Webhook endpoint found (returns Method Not Allowed as expected)</span>';
                } else {
                    result.innerHTML = `<span class="error">‚ùå Unexpected response: ${response.status}</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Webhook endpoint not reachable: ${error.message}</span>`;
            }
        }

        async function testCheckoutSession() {
            const result = document.getElementById('checkout-result');
            result.innerHTML = 'Testing checkout session creation...';

            try {
                const response = await fetch(`${API_BASE}/api/create-checkout-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: 'price_test_123', // Test price ID
                        userId: 'test_user_123',
                        email: 'test@example.com'
                    })
                });

                const data = await response.json();

                if (response.ok && data.sessionId) {
                    result.innerHTML = `<span class="success">‚úÖ Checkout session created: ${data.sessionId}</span>`;
                } else {
                    result.innerHTML = `<span class="error">‚ùå Error: ${data.error || 'Unknown error'}</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Request failed: ${error.message}</span>`;
            }
        }

        async function checkEnvironment() {
            const result = document.getElementById('env-result');
            result.innerHTML = 'Checking environment configuration...';

            try {
                const response = await fetch(`${API_BASE}/api/create-checkout-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Empty body to trigger validation
                });

                const data = await response.json();

                if (data.error && data.error.includes('Missing required fields')) {
                    result.innerHTML = '<span class="success">‚úÖ API endpoint configured correctly</span>';
                } else if (data.error && data.error.includes('Stripe not configured')) {
                    result.innerHTML = '<span class="error">‚ùå Stripe environment variables not set</span>';
                } else {
                    result.innerHTML = `<span class="error">‚ùå Unexpected response: ${data.error}</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Environment check failed: ${error.message}</span>`;
            }
        }

        function openTestPayment() {
            // This would normally create a real checkout session
            alert('Set up your Stripe keys first, then this will open a real payment form!');
        }

        // Run basic tests on page load
        window.addEventListener('load', () => {
            console.log('üß™ Stripe Integration Test Page Loaded');
            console.log('API Base URL:', API_BASE);
        });
    </script>
</body>
</html>