<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneBat-Style Audio Analysis Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .upload-area.dragover {
            border-color: #007cba;
            background: #f0f8ff;
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .feature-bars {
            margin: 20px 0;
        }
        
        .feature-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .feature-bar label {
            width: 120px;
            font-weight: bold;
        }
        
        .bar {
            flex: 1;
            height: 16px;
            background: #e0e0e0;
            border-radius: 8px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #03DAC6);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .candidates {
            margin: 10px 0;
        }
        
        .candidate {
            display: inline-block;
            margin: 4px;
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .method-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .client-side { background: #4CAF50; }
        .hybrid { background: #FF9800; }
        .server-fallback { background: #F44336; }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .confidence-meter .bar {
            width: 200px;
            margin: 0 10px;
        }
        
        .confidence-meter .fill {
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
        }
    </style>
</head>
<body>
    <h1>üéØ TuneBat-Style Audio Analysis Test</h1>
    <p>Test the enhanced client-side audio analysis with TuneBat's multi-algorithm approach</p>
    
    <div class="test-container">
        <h2>Upload Audio File</h2>
        <div class="upload-area" id="uploadArea">
            <p>Drag and drop an audio file here or click to select</p>
            <input type="file" id="audioFile" accept="audio/*" style="display: none;">
            <button onclick="document.getElementById('audioFile').click()">Choose File</button>
        </div>
        
        <div id="progress" class="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p id="status" style="text-align: center; margin: 10px 0;"></p>
    </div>
    
    <div class="test-container" id="results" style="display: none;">
        <h2>üéµ Analysis Results</h2>
        
        <div class="confidence-meter">
            <label>Overall Confidence:</label>
            <div class="bar">
                <div class="fill" id="confidenceFill"></div>
            </div>
            <span id="confidenceText">0%</span>
            <span class="method-indicator" id="methodIndicator">Unknown</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
            <div>
                <h3>ü•Å Tempo Analysis</h3>
                <p><strong>BPM:</strong> <span id="bpmResult">-</span></p>
                <div id="bpmCandidates" class="candidates"></div>
            </div>
            
            <div>
                <h3>üéº Key Analysis</h3>
                <p><strong>Key:</strong> <span id="keyResult">-</span></p>
                <div id="keyCandidates" class="candidates"></div>
            </div>
        </div>
        
        <div class="feature-bars">
            <h3>üé≠ Mood Features</h3>
            <div class="feature-bar">
                <label>Energy:</label>
                <div class="bar"><div class="fill" id="energyFill"></div></div>
                <span id="energyText">0%</span>
            </div>
            <div class="feature-bar">
                <label>Danceability:</label>
                <div class="bar"><div class="fill" id="danceabilityFill"></div></div>
                <span id="danceabilityText">0%</span>
            </div>
            <div class="feature-bar">
                <label>Positivity:</label>
                <div class="bar"><div class="fill" id="valenceFill"></div></div>
                <span id="valenceText">0%</span>
            </div>
        </div>
        
        <div id="additionalFeatures" style="margin-top: 20px;">
            <h3>üìä Additional Features</h3>
            <div id="extraFeatures"></div>
        </div>
        
        <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
            <h4>üîß Technical Details</h4>
            <p><strong>Duration:</strong> <span id="duration">-</span></p>
            <p><strong>Sample Rate:</strong> <span id="sampleRate">-</span></p>
            <p><strong>Analysis Time:</strong> <span id="analysisTime">-</span></p>
        </div>
    </div>
    
    <div class="test-container">
        <h2>‚öôÔ∏è Settings</h2>
        <label>
            <input type="checkbox" id="enableServerFallback" checked> Enable Server Fallback
        </label><br>
        <label>
            Confidence Threshold: <input type="range" id="confidenceThreshold" min="0.3" max="0.9" step="0.1" value="0.7">
            <span id="thresholdValue">0.7</span>
        </label>
    </div>
    
    <!-- Scripts -->
    <script src="audio-analyzer.js"></script>
    <script src="tunebat-analyzer.js"></script>
    <script src="enhanced-audio-manager.js"></script>
    
    <script>
        let audioContext;
        let enhancedAnalyzer;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                enhancedAnalyzer = new EnhancedAudioManager(audioContext);
                
                // Setup settings
                const serverFallback = document.getElementById('enableServerFallback');
                const confidenceThreshold = document.getElementById('confidenceThreshold');
                const thresholdValue = document.getElementById('thresholdValue');
                
                serverFallback.addEventListener('change', (e) => {
                    enhancedAnalyzer.setServerFallback(e.target.checked);
                });
                
                confidenceThreshold.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    enhancedAnalyzer.setConfidenceThreshold(value);
                    thresholdValue.textContent = value.toFixed(1);
                });
                
                // Apply initial settings
                enhancedAnalyzer.setServerFallback(serverFallback.checked);
                enhancedAnalyzer.setConfidenceThreshold(parseFloat(confidenceThreshold.value));
                
                console.log('‚úÖ Test page initialized');
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                document.getElementById('status').textContent = 'Initialization failed: ' + error.message;
            }
        });
        
        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const audioFile = document.getElementById('audioFile');
        
        uploadArea.addEventListener('click', () => audioFile.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        audioFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        async function handleFile(file) {
            try {
                showProgress('Loading audio file...');
                
                // Read file as array buffer
                const arrayBuffer = await file.arrayBuffer();
                
                showProgress('Decoding audio...');
                
                // Resume audio context if needed
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Decode audio
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Analyze
                showProgress('Analyzing with TuneBat algorithms...');
                const startTime = performance.now();
                
                const results = await enhancedAnalyzer.analyzeAudio(audioBuffer);
                
                const analysisTime = performance.now() - startTime;
                
                hideProgress();
                displayResults(results, analysisTime, file.name);
                
            } catch (error) {
                console.error('‚ùå Analysis failed:', error);
                hideProgress();
                document.getElementById('status').textContent = 'Analysis failed: ' + error.message;
            }
        }
        
        function showProgress(message) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('status').textContent = message;
            document.getElementById('results').style.display = 'none';
        }
        
        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
            document.getElementById('status').textContent = '';
        }
        
        function displayResults(results, analysisTime, fileName) {
            console.log('üìä Analysis Results:', results);
            
            // Show results container
            document.getElementById('results').style.display = 'block';
            
            // Confidence and method
            const confidence = (results.confidence || 0.5) * 100;
            document.getElementById('confidenceFill').style.width = confidence + '%';
            document.getElementById('confidenceText').textContent = confidence.toFixed(1) + '%';
            
            const methodIndicator = document.getElementById('methodIndicator');
            const method = results.analysisMethod || 'unknown';
            methodIndicator.textContent = method;
            methodIndicator.className = 'method-indicator ' + 
                (method.includes('client') ? 'client-side' : 
                 method.includes('hybrid') ? 'hybrid' : 'server-fallback');
            
            // BPM
            document.getElementById('bpmResult').textContent = Math.round(results.bpm) + ' BPM';
            
            const bpmCandidates = document.getElementById('bpmCandidates');
            bpmCandidates.innerHTML = '';
            if (results.bpmCandidates && results.bpmCandidates.length > 1) {
                results.bpmCandidates.slice(0, 5).forEach(candidate => {
                    const span = document.createElement('span');
                    span.className = 'candidate';
                    span.textContent = `${Math.round(candidate.bpm)} BPM (${(candidate.confidence * 100).toFixed(1)}%)`;
                    bpmCandidates.appendChild(span);
                });
            }
            
            // Key
            document.getElementById('keyResult').textContent = results.key;
            
            const keyCandidates = document.getElementById('keyCandidates');
            keyCandidates.innerHTML = '';
            if (results.keyCandidates && results.keyCandidates.length > 1) {
                results.keyCandidates.slice(0, 5).forEach(candidate => {
                    const span = document.createElement('span');
                    span.className = 'candidate';
                    span.textContent = `${candidate.key} (${(candidate.confidence * 100).toFixed(1)}%)`;
                    keyCandidates.appendChild(span);
                });
            }
            
            // Mood features
            if (results.energy !== undefined) {
                const energyPercent = results.energy * 100;
                document.getElementById('energyFill').style.width = energyPercent + '%';
                document.getElementById('energyText').textContent = energyPercent.toFixed(0) + '%';
            }
            
            if (results.danceability !== undefined) {
                const danceabilityPercent = results.danceability * 100;
                document.getElementById('danceabilityFill').style.width = danceabilityPercent + '%';
                document.getElementById('danceabilityText').textContent = danceabilityPercent.toFixed(0) + '%';
            }
            
            if (results.valence !== undefined) {
                const valencePercent = results.valence * 100;
                document.getElementById('valenceFill').style.width = valencePercent + '%';
                document.getElementById('valenceText').textContent = valencePercent.toFixed(0) + '%';
            }
            
            // Additional features
            const extraFeatures = document.getElementById('extraFeatures');
            extraFeatures.innerHTML = '';
            
            if (results.tempoStability !== undefined) {
                extraFeatures.innerHTML += `<p>Tempo Stability: ${(results.tempoStability * 100).toFixed(0)}%</p>`;
            }
            if (results.rhythmComplexity !== undefined) {
                extraFeatures.innerHTML += `<p>Rhythm Complexity: ${(results.rhythmComplexity * 100).toFixed(0)}%</p>`;
            }
            if (results.harmonicComplexity !== undefined) {
                extraFeatures.innerHTML += `<p>Harmonic Complexity: ${(results.harmonicComplexity * 100).toFixed(0)}%</p>`;
            }
            
            // Technical details
            document.getElementById('duration').textContent = formatDuration(results.duration);
            document.getElementById('sampleRate').textContent = results.sampleRate + ' Hz';
            document.getElementById('analysisTime').textContent = analysisTime.toFixed(1) + ' ms';
            
            document.getElementById('status').textContent = `‚úÖ Analysis complete for ${fileName}`;
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>