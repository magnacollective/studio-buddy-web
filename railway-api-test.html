<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway API Test - Audio Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .results {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .loading {
            color: #ffd43b;
        }
        #log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Railway API Test - Audio Analysis & Stem Separation</h1>
    
    <div class="container">
        <h2>üîß API Health Check</h2>
        <button onclick="checkHealth()">Check Railway API Health</button>
        <button onclick="getVersion()">Get API Version</button>
        <div id="health-status"></div>
    </div>

    <div class="container">
        <h2>üéµ Audio Analysis Test</h2>
        <input type="file" id="audioFile" accept="audio/*">
        <br>
        <button onclick="analyzeAudio()">Analyze Audio (Railway API)</button>
        <div id="analysis-results"></div>
    </div>

    <div class="container">
        <h2>üé§ Stem Separation Test</h2>
        <button onclick="separateStems('vocals')" disabled id="vocalsBtn">Extract Vocals</button>
        <button onclick="separateStems('instrumental')" disabled id="instrumentalBtn">Extract Instrumental</button>
        <button onclick="separateStems('drums')" disabled id="drumsBtn">Extract Drums</button>
        <button onclick="separateStems('bass')" disabled id="bassBtn">Extract Bass</button>
        <div id="separation-results"></div>
    </div>

    <div class="container">
        <h2>üìã Console Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script src="railway-api-manager.js"></script>
    <script>
        let railwayAPI;
        let currentAudioBuffer;
        let audioContext;

        // Initialize
        window.addEventListener('load', async () => {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                railwayAPI = new RailwayAPIManager();
                log('‚úÖ Railway API Manager initialized');
                
                // Auto-check health on load
                await checkHealth();
            } catch (error) {
                log('‚ùå Failed to initialize: ' + error.message, 'error');
            }
        });

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'loading' ? '‚è≥' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.innerHTML = '<span class="loading">Checking API health...</span>';
            
            try {
                log('Checking Railway API health...', 'loading');
                const isHealthy = await railwayAPI.checkHealth();
                
                if (isHealthy) {
                    statusDiv.innerHTML = '<span class="success">‚úÖ Railway API is healthy</span>';
                    log('Railway API is healthy', 'success');
                } else {
                    statusDiv.innerHTML = '<span class="error">‚ùå Railway API is not responding</span>';
                    log('Railway API is not responding', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå Health check failed: ${error.message}</span>`;
                log('Health check failed: ' + error.message, 'error');
            }
        }

        async function getVersion() {
            const statusDiv = document.getElementById('health-status');
            
            try {
                log('Getting Railway API version...', 'loading');
                const version = await railwayAPI.getVersion();
                
                if (version) {
                    statusDiv.innerHTML += `<br><span class="success">Version: ${JSON.stringify(version)}</span>`;
                    log('API version: ' + JSON.stringify(version), 'success');
                } else {
                    statusDiv.innerHTML += '<br><span class="error">‚ùå Could not get version info</span>';
                    log('Could not get version info', 'error');
                }
            } catch (error) {
                log('Version check failed: ' + error.message, 'error');
            }
        }

        async function analyzeAudio() {
            const fileInput = document.getElementById('audioFile');
            const resultsDiv = document.getElementById('analysis-results');
            
            if (!fileInput.files[0]) {
                alert('Please select an audio file first');
                return;
            }

            const file = fileInput.files[0];
            log(`Loading file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'loading');

            try {
                // Load audio file
                const arrayBuffer = await file.arrayBuffer();
                currentAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                log(`Audio loaded: ${currentAudioBuffer.duration.toFixed(2)}s, ${currentAudioBuffer.sampleRate}Hz`, 'success');
                
                // Enable stem separation buttons
                document.getElementById('vocalsBtn').disabled = false;
                document.getElementById('instrumentalBtn').disabled = false;
                document.getElementById('drumsBtn').disabled = false;
                document.getElementById('bassBtn').disabled = false;

                resultsDiv.innerHTML = '<span class="loading">Analyzing audio via Railway API...</span>';
                log('Starting Railway API analysis...', 'loading');

                // Analyze via Railway API
                const analysisOptions = {
                    window_sec: 75,
                    prefer_min_bpm: 90,
                    prefer_max_bpm: 180,
                    profile: 'accurate',
                    backend: 'pro'
                };

                const result = await railwayAPI.analyzeAudio(currentAudioBuffer, analysisOptions);
                
                // Display results
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>Analysis Results (Railway API)</h3>
                        <p><strong>BPM:</strong> ${result.bpm}</p>
                        <p><strong>Key:</strong> ${result.key}</p>
                        <p><strong>Duration:</strong> ${result.duration}</p>
                        <p><strong>Sample Rate:</strong> ${result.sampleRate}</p>
                        <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                        <p><strong>Method:</strong> ${result.analysisMethod}</p>
                        ${result.bpmCandidates ? `<p><strong>BPM Candidates:</strong> ${result.bpmCandidates.slice(0,3).map(c => `${c.bpm} (${(c.confidence*100).toFixed(1)}%)`).join(', ')}</p>` : ''}
                    </div>
                `;

                log('Analysis completed successfully', 'success');
                log(`Results: ${result.bpm} BPM, ${result.key}, confidence: ${(result.confidence * 100).toFixed(1)}%`, 'success');

            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Analysis failed: ${error.message}</span>`;
                log('Analysis failed: ' + error.message, 'error');
            }
        }

        async function separateStems(stemType) {
            if (!currentAudioBuffer) {
                alert('Please analyze an audio file first');
                return;
            }

            const resultsDiv = document.getElementById('separation-results');
            resultsDiv.innerHTML = `<span class="loading">Separating ${stemType} using Railway API (HTDemucs)...</span>`;
            log(`Starting ${stemType} separation...`, 'loading');

            try {
                const result = await railwayAPI.separateStems(currentAudioBuffer, stemType);
                
                // Create download link
                const url = URL.createObjectURL(result.audioBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${stemType}_separated.wav`;
                link.textContent = `Download ${stemType}.wav`;
                link.style.display = 'block';
                link.style.color = '#51cf66';
                link.style.textDecoration = 'none';
                link.style.padding = '10px';
                link.style.background = '#2a2a2a';
                link.style.borderRadius = '4px';
                link.style.margin = '10px 0';

                resultsDiv.innerHTML = `<div class="success">
                    <h3>${stemType} Separation Complete</h3>
                    <p>AI-separated ${stemType} is ready for download:</p>
                </div>`;
                resultsDiv.appendChild(link);

                log(`${stemType} separation completed successfully`, 'success');

            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå ${stemType} separation failed: ${error.message}</span>`;
                log(`${stemType} separation failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>