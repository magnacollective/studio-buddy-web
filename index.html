<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Buddy - Audio Mastering Professional</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Matrix Background -->
    <div id="matrix-background"></div>
    
    <!-- Desktop -->
    <div id="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icons">
            <div class="desktop-icon" data-window="studio-buddy" onclick="console.log('CLICK TEST 1'); openDesktopWindow('studio-buddy')">
                <div class="icon">üéµ</div>
                <div class="label">Studio Buddy</div>
            </div>
            <div class="desktop-icon" data-window="analyzer" onclick="console.log('CLICK TEST 2'); openDesktopWindow('analyzer')">
                <div class="icon">üìä</div>
                <div class="label">Key/BPM Analyzer</div>
            </div>
            <div class="desktop-icon" data-window="settings" onclick="console.log('CLICK TEST 3'); openDesktopWindow('settings')">
                <div class="icon">‚öôÔ∏è</div>
                <div class="label">Settings</div>
            </div>
        </div>

        <!-- Windows -->
        <div id="windows-container">
            <!-- Studio Buddy Window -->
            <div class="window" id="studio-buddy-window" style="display: none;">
                <div class="title-bar">
                    <div class="title-bar-text">Studio Buddy - Audio Mastering Professional</div>
                    <div class="title-bar-controls">
                        <button class="title-bar-control" onclick="minimizeWindow('studio-buddy-window')">_</button>
                        <button class="title-bar-control" onclick="maximizeWindow('studio-buddy-window')">‚ñ°</button>
                        <button class="title-bar-control" onclick="closeWindow('studio-buddy-window')">√ó</button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="studio-buddy-content">
                        <div class="section">
                            <h3>Audio Files</h3>
                            <div class="file-section">
                                <label>Source Audio:</label>
                                <input type="file" id="source-file" accept="audio/*">
                                <div id="source-info" class="file-info"></div>
                            </div>
                            <div class="file-section">
                                <label>Reference Audio (Optional):</label>
                                <input type="file" id="reference-file" accept="audio/*">
                                <div id="reference-info" class="file-info"></div>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Mastering Controls</h3>
                            <div class="controls-grid">
                                <div class="control-group">
                                    <label>Output Level:</label>
                                    <input type="range" id="output-level" min="-6" max="0" value="-1" step="0.1">
                                    <span id="output-level-value">-1.0 dB</span>
                                </div>
                                <div class="control-group">
                                    <label>Compression:</label>
                                    <input type="range" id="compression" min="1" max="10" value="3" step="1">
                                    <span id="compression-value">3</span>
                                </div>
                                <div class="control-group">
                                    <label>EQ Intensity:</label>
                                    <input type="range" id="eq-intensity" min="0" max="100" value="50" step="5">
                                    <span id="eq-intensity-value">50%</span>
                                </div>
                                <div class="control-group">
                                    <label>Stereo Width:</label>
                                    <input type="range" id="stereo-width" min="0" max="150" value="100" step="5">
                                    <span id="stereo-width-value">100%</span>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Processing</h3>
                            <button id="master-button" class="master-button" disabled>Master Audio</button>
                            <div id="progress-container" style="display: none;">
                                <div class="progress-bar">
                                    <div id="progress-fill"></div>
                                </div>
                                <div id="progress-text">Processing...</div>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Playback</h3>
                            <div class="playback-controls">
                                <button id="play-source" disabled>Play Source</button>
                                <button id="play-reference" disabled>Play Reference</button>
                                <button id="play-mastered" disabled>Play Mastered</button>
                                <button id="download-mastered" disabled>Download Mastered</button>
                            </div>
                            <div class="audio-visualizer">
                                <canvas id="waveform-canvas" width="400" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Analyzer Window -->
            <div class="window" id="analyzer-window" style="display: none;">
                <div class="title-bar">
                    <div class="title-bar-text">Key/BPM Analyzer Professional</div>
                    <div class="title-bar-controls">
                        <button class="title-bar-control" onclick="minimizeWindow('analyzer-window')">_</button>
                        <button class="title-bar-control" onclick="maximizeWindow('analyzer-window')">‚ñ°</button>
                        <button class="title-bar-control" onclick="closeWindow('analyzer-window')">√ó</button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="analyzer-content">
                        <div class="section">
                            <h3>Audio Analysis</h3>
                            <input type="file" id="analyze-file" accept="audio/*">
                            <button id="analyze-button" disabled>Analyze</button>
                        </div>
                        
                        <div class="section">
                            <h3>Results</h3>
                            <div class="results-grid">
                                <div class="result-item">
                                    <label>BPM:</label>
                                    <span id="bpm-result">-</span>
                                </div>
                                <div class="result-item">
                                    <label>Key:</label>
                                    <span id="key-result">-</span>
                                </div>
                                <div class="result-item">
                                    <label>Duration:</label>
                                    <span id="duration-result">-</span>
                                </div>
                                <div class="result-item">
                                    <label>Sample Rate:</label>
                                    <span id="samplerate-result">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Frequency Analysis</h3>
                            <canvas id="spectrum-canvas" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Window -->
            <div class="window" id="settings-window" style="display: none;">
                <div class="title-bar">
                    <div class="title-bar-text">System Settings</div>
                    <div class="title-bar-controls">
                        <button class="title-bar-control" onclick="minimizeWindow('settings-window')">_</button>
                        <button class="title-bar-control" onclick="maximizeWindow('settings-window')">‚ñ°</button>
                        <button class="title-bar-control" onclick="closeWindow('settings-window')">√ó</button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="settings-content">
                        <div class="section">
                            <h3>Audio Settings</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="auto-normalize" checked>
                                    Auto-normalize output
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="enable-limiting" checked>
                                    Enable brickwall limiting
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="psychoacoustic-processing" checked>
                                    Psychoacoustic processing
                                </label>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Performance</h3>
                            <div class="setting-item">
                                <label>Buffer Size:</label>
                                <select id="buffer-size">
                                    <option value="512">512 samples</option>
                                    <option value="1024" selected>1024 samples</option>
                                    <option value="2048">2048 samples</option>
                                    <option value="4096">4096 samples</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>Quality:</label>
                                <select id="quality-setting">
                                    <option value="draft">Draft</option>
                                    <option value="standard" selected>Standard</option>
                                    <option value="high">High Quality</option>
                                    <option value="ultimate">Ultimate</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <button class="start-button">üè† Home</button>
            <div class="taskbar-separator"></div>
            <div id="task-buttons"></div>
            <div class="system-tray">
                <span class="volume-icon">üîä</span>
                <span id="clock"></span>
            </div>
        </div>
    </div>

    <script src="audio-processor.js"></script>
    <script src="audio-analyzer.js"></script>
    <script src="script.js"></script>
    
    <!-- Immediate console output to verify loading -->
    <script>
        console.log('üìÑ HTML script block executing...');
        console.log('üìç Current time:', new Date().toISOString());
        console.log('üåê User agent:', navigator.userAgent);
        console.log('üîó Page URL:', window.location.href);
    </script>
    
    <!-- Initialize the app after all scripts are loaded -->
    <script>
        // Global function to handle desktop icon clicks
        function openDesktopWindow(windowId) {
            console.log('üñ±Ô∏è Desktop icon clicked:', windowId);
            
            // Direct window opening without waiting for app initialization
            const windowElement = document.getElementById(windowId + '-window');
            console.log('üîç Looking for element:', windowId + '-window');
            console.log('üîç Element found:', !!windowElement);
            
            if (windowElement) {
                console.log('üì¶ Current display style:', windowElement.style.display);
                windowElement.style.display = 'flex';
                windowElement.style.zIndex = '100';
                windowElement.style.position = 'fixed';
                windowElement.style.top = '50px';
                windowElement.style.left = '50px';
                console.log('‚úÖ Window opened and positioned:', windowId);
                console.log('üì¶ New display style:', windowElement.style.display);
                
                // Add to taskbar if app is initialized
                if (window.studioBuddyApp) {
                    window.studioBuddyApp.addTaskButton(windowId);
                    window.studioBuddyApp.setActiveWindow(windowId);
                }
            } else {
                console.error('‚ùå Window not found:', windowId + '-window');
                // List all available windows for debugging
                const allWindows = document.querySelectorAll('.window');
                console.log('üîç Available windows:', Array.from(allWindows).map(w => w.id));
            }
        }
        
        // Test function to verify window existence
        function testWindows() {
            console.log('üß™ Testing window availability...');
            const windowIds = ['studio-buddy', 'analyzer', 'settings'];
            windowIds.forEach(id => {
                const element = document.getElementById(id + '-window');
                console.log(`Window ${id}:`, !!element);
            });
        }
        
        // Ensure all classes are loaded before initializing
        window.addEventListener('load', () => {
            console.log('üöÄ Page loaded, starting initialization...');
            
            // Test window availability first
            testWindows();
            
            // Check if classes are available with detailed logging
            console.log('AudioProcessor available:', typeof AudioProcessor);
            console.log('AudioAnalyzer available:', typeof AudioAnalyzer);
            console.log('StudioBuddyApp available:', typeof StudioBuddyApp);
            
            if (typeof AudioProcessor === 'undefined') {
                console.error('‚ùå AudioProcessor class not found - continuing without it');
            }
            
            if (typeof AudioAnalyzer === 'undefined') {
                console.error('‚ùå AudioAnalyzer class not found - continuing without it');
            }
            
            if (typeof StudioBuddyApp === 'undefined') {
                console.error('‚ùå StudioBuddyApp class not found - setting up basic functionality');
                setupBasicFunctionality();
                return;
            }
            
            // Initialize the app
            try {
                console.log('üîß Attempting to create StudioBuddyApp instance...');
                window.studioBuddyApp = new StudioBuddyApp();
                console.log('‚úÖ Studio Buddy Web initialized successfully');
            } catch (error) {
                console.error('‚ùå Failed to initialize Studio Buddy:', error);
                console.error('Error details:', error.stack);
                
                // Fallback to basic functionality
                console.log('üîß Setting up basic window functionality...');
                setupBasicFunctionality();
            }
        });
        
        // Fallback basic functionality if main app fails
        function setupBasicFunctionality() {
            console.log('üîß Setting up basic click handlers...');
            
            // Add direct event listeners to desktop icons
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                console.log('Adding click listener to:', icon.dataset.window);
                icon.addEventListener('click', (e) => {
                    console.log('üñ±Ô∏è Basic click handler triggered:', e.currentTarget.dataset.window);
                    openDesktopWindow(e.currentTarget.dataset.window);
                });
            });
            
            console.log('‚úÖ Basic functionality setup complete');
        }
    </script>
</body>
</html>